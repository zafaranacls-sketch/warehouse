<!doctype html>

<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø²Ù†</title>
<style>
:root{
  --we-purple:#6c2d9b;
  --we-purple-dark:#4a1f6e;
  --card-bg: #fff;
  --muted:#666;
}
*{box-sizing:border-box}
body{font-family: Tahoma, Arial, sans-serif;background:#f6f6fb;margin:0;color:#222}
header{background:linear-gradient(90deg,var(--we-purple),var(--we-purple-dark));color:#fff;padding:18px 20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap}
header h1{margin:0;font-size:18px}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
.controls input{padding:8px;border-radius:6px;border:0;min-width:200px}
.controls button{padding:8px 10px;border-radius:6px;border:0;background:#fff;color:var(--we-purple);cursor:pointer}
main{padding:18px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
.card{background:var(--card-bg);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(28,20,40,0.06);border-left:6px solid var(--we-purple)}
.card h2{margin:0 0 8px 0}
.card p{margin:0;color:var(--muted)}
.rack-card{cursor:pointer}
.box-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.box{background:#f2f2f9;padding:6px 10px;border-radius:8px;font-size:13px}
.box .meta{font-size:11px;color:var(--muted);display:block}
.actions{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
.actions button{padding:6px 8px;border-radius:8px;border:0;background:var(--we-purple);color:#fff;cursor:pointer}
.small{padding:6px 8px;font-size:12px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center}
.modal.hidden{display:none}
.modal-inner{background:#fff;padding:18px;border-radius:12px;width:320px}
.modal-inner label{display:block;margin-bottom:8px}
.modal-inner input, .modal-inner select{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #ddd}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
</style>
</head>
<body>
<header>
  <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø²Ù†</h1>
  <div class="controls">
    <input id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù€Ù… Ø§Ù„Ø¨ÙˆÙƒØ³ Ø£Ùˆ Ù†ÙˆØ¹Ù‡..." />
    <button id="searchBtn">ğŸ” Ø¨Ø­Ø«</button>
    <button id="addBtn">â• Ø¥Ø¶Ø§ÙØ© Box</button>
    <button id="backBtn" style="display:none">â† Ø±Ø¬ÙˆØ¹</button>
  </div>
</header><main id="app"></main><div id="modal" class="modal hidden">
  <div class="modal-inner">
    <h3>Ø¥Ø¶Ø§ÙØ© Box Ø¬Ø¯ÙŠØ¯</h3>
    <label>Ø§Ù„Ù…Ø®Ø²Ù†<select id="modalStore"></select></label>
    <label>Ø§Ù„Ø±Ø§Ùƒ<select id="modalRack"></select></label>
    <label>Ø§Ù„Ø´ÙŠÙ„Ù<select id="modalShelf"></select></label>
    <label>Ø±Ù‚Ù… Ø§Ù„Ø¨ÙˆÙƒØ³<input id="modalBoxId" /></label>
    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙˆÙƒØ³<input id="modalBoxType" /></label>
    <div class="modal-actions">
      <button id="modalSave">Ø­ÙØ¸</button>
      <button id="modalCancel">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div><script>
// --- Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Apps Script Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (Ø§Ù„Ø°ÙŠ ÙˆØ¶Ø¹ØªÙ‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹) ---
const API_URL = "https://script.google.com/macros/s/AKfycbwm3ijQv2LDTQ2OzonjAvZJaMBwAYOaGzTWqRQMUoT59pouGv1Jk8JwiwmbiPL5m_5R/exec";

// Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ø­Ù„ÙŠØ© (ØªÙØ¹Ø±Ø¶ Ø¥Ø°Ø§ Ø§Ù„Ø´ÙŠØª ÙØ§Ø¶ÙŠ)
const STORE_DATA = [
  {name:'Ø§Ù„Ù…Ø®Ø²Ù† 1', racks:[{id:'Rack 1', label:'TE-MESH', shelves:[{id:'SH1', boxes:[]},{id:'SH2', boxes:[]},{id:'SH3', boxes:[]}]}]},
  {name:'Ø§Ù„Ù…Ø®Ø²Ù† 2', racks:[{id:'Rack 1', label:'FIBER', shelves:[{id:'SH1', boxes:[]},{id:'SH2', boxes:[]}] } ]}
];

const app=document.getElementById('app'),searchInput=document.getElementById('searchInput'),searchBtn=document.getElementById('searchBtn'),addBtn=document.getElementById('addBtn'),backBtn=document.getElementById('backBtn'),modal=document.getElementById('modal');
let state={stores:STORE_DATA,view:'stores',storeIndex:null,rackIndex:null};

// ---------- API helpers ----------
async function apiAdd(row){
  const res = await fetch(API_URL, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(row)
  });
  return await res.json();
}
async function apiList(){
  const res = await fetch(API_URL + '?action=list');
  return await res.json();
}
async function apiDelete(id){
  const res = await fetch(API_URL + '?action=delete&id=' + encodeURIComponent(id));
  return await res.text();
}
async function apiUpdate(id, updates){
  const params = new URLSearchParams({action:'update', id: id});
  Object.keys(updates).forEach(k=> params.append(k, updates[k]));
  const res = await fetch(API_URL + '?' + params.toString());
  return await res.text();
}

// ØªØ­ÙˆÙŠÙ„ ØµÙÙˆÙ Ø§Ù„Ø´ÙŠØª Ø¥Ù„Ù‰ Ù‡ÙŠÙƒÙ„ stores Ø§Ù„Ù…Ø±ØºÙˆØ¨ (ÙŠØ¯Ø¹Ù… Ø´ÙƒÙ„ÙŠÙ†: array-of-arrays Ø£Ùˆ array-of-objects)
function rowsToStores(rows){
  const storesMap = {};
  if(!rows) return [];
  // detect format
  if(Array.isArray(rows) && rows.length>0 && Array.isArray(rows[0])){
    // array-of-arrays, Ø§ÙØªØ±Ø¶ Ø£ÙˆÙ„ ØµÙ Ù‡Ùˆ header
    const data = rows.slice(1);
    data.forEach(r=>{
      const st = r[1] || 'Ø§Ù„Ù…Ø®Ø²Ù† 1';
      const rack = r[2] || 'Rack 1';
      const shelf = r[3] || 'SH1';
      const box = r[4] || '';
      const type = r[5] || '';
      const id = r[0] || null;
      if(!storesMap[st]) storesMap[st] = {name:st, racks:[]};
      let rk = storesMap[st].racks.find(x=>x.id===rack);
      if(!rk){ rk={id:rack,label:'',shelves:[]}; storesMap[st].racks.push(rk); }
      let sh = rk.shelves.find(x=>x.id===shelf);
      if(!sh){ sh={id:shelf,boxes:[]}; rk.shelves.push(sh); }
      sh.boxes.push({boxId: String(box), type: String(type), _id: id});
    });
  } else if(Array.isArray(rows) && rows.length>0 && typeof rows[0] === 'object'){
    // array-of-objects: each row has keys like id,store,rack,shelf,box,type
    rows.forEach(r=>{
      const st = r.store || r.Store || r['store'] || 'Ø§Ù„Ù…Ø®Ø²Ù† 1';
      const rack = r.rack || 'Rack 1';
      const shelf = r.shelf || 'SH1';
      const box = r.box || '';
      const type = r.type || '';
      const id = r.id || r.ID || null;
      if(!storesMap[st]) storesMap[st] = {name:st, racks:[]};
      let rk = storesMap[st].racks.find(x=>x.id===rack);
      if(!rk){ rk={id:rack,label:'',shelves:[]}; storesMap[st].racks.push(rk); }
      let sh = rk.shelves.find(x=>x.id===shelf);
      if(!sh){ sh={id:shelf,boxes:[]}; rk.shelves.push(sh); }
      sh.boxes.push({boxId: String(box), type: String(type), _id: id});
    });
  }
  return Object.values(storesMap);
}

// ---------- load/init ----------
async function load(){
  try{
    const rows = await apiList();
    // console.log('api rows',rows);
    const stores = rowsToStores(rows);
    if(stores.length) state.stores = stores; // if empty keep fallback
    renderStores();
  }catch(err){
    console.error('Error loading from API', err);
    // fallback to local data
    renderStores();
  }
}
async function init(){ await load(); }

// ---------- UI rendering ----------
function clearMain(){app.innerHTML='';}
function renderStores(){state.view='stores';backBtn.style.display='none';clearMain();const grid=document.createElement('div');grid.className='grid';state.stores.forEach((st,i)=>{const card=document.createElement('div');card.className='card';card.innerHTML=<h2>${st.name}</h2><p>Racks: ${st.racks.length}</p>;card.addEventListener('click',()=>openStore(i));grid.appendChild(card);});app.appendChild(grid);} 
function openStore(i){state.storeIndex=i;state.view='racks';backBtn.style.display='inline-block';renderRacks();}
function renderRacks(){clearMain();const st=state.stores[state.storeIndex];const grid=document.createElement('div');grid.className='grid';st.racks.forEach((rk,ri)=>{const card=document.createElement('div');card.className='card rack-card';card.innerHTML=<h2>${rk.id}</h2><p>${rk.label||''}</p><div class="box-list">${rk.shelves.map(s=><span class="box">${s.id} (${s.boxes.length})</span>).join('')}</div>;card.addEventListener('click',()=>openRack(ri));grid.appendChild(card);});const actions=document.createElement('div');actions.className='actions';const addRack=document.createElement('button');addRack.textContent='â• Ø¥Ø¶Ø§ÙØ© Rack';addRack.className='small';addRack.onclick=()=>{const id=prompt('Ø§Ø³Ù… Ø§Ù„Rack Ù…Ø«Ù„Ø§Ù‹ Rack 6');if(!id)return;st.racks.push({id,label:'',shelves:[]});renderRacks();};actions.appendChild(addRack);app.appendChild(grid);app.appendChild(actions);} 
function openRack(index){state.rackIndex=index;state.view='shelves';backBtn.style.display='inline-block';renderShelves();}
function renderShelves(){clearMain();const st=state.stores[state.storeIndex];const rk=st.racks[state.rackIndex];const container=document.createElement('div');container.innerHTML=<h2>${st.name} â€º ${rk.id} <small style='color:#666;margin-right:8px'>${rk.label||''}</small></h2>;rk.shelves.forEach((sh,si)=>{const card=document.createElement('div');card.className='card';const boxesHtml=(sh.boxes||[]).map(b=>{ const boxLabel = typeof b === 'object' ? b.boxId : b; const boxType = typeof b === 'object' ? (b.type||'') : ''; const idAttr = typeof b === 'object' ? b._id : ''; return <div class='box'><strong>${boxLabel}</strong><span class='meta'>${sh.note||''}${boxType?(' | '+boxType):''}</span><div style='margin-top:6px'><button class='small' onclick='editBox(${si},"${boxLabel}","${idAttr}")'>âœï¸</button> <button class='small' onclick='deleteBox(${si},"${boxLabel}","${idAttr}")'>ğŸ—‘ï¸</button> <a class='small' target='_blank' href='https://chart.googleapis.com/chart?chs=150x150&cht=qr&chl=${encodeURIComponent(st.name+"|"+rk.id+"|"+sh.id+"|"+boxLabel)}'>QR</a></div></div> }).join('');card.innerHTML=<h3>${sh.id}</h3><p>${sh.note||''}</p><div class='box-list'>${boxesHtml}</div>;container.appendChild(card);});const controls=document.createElement('div');controls.className='actions';const addShelf=document.createElement('button');addShelf.textContent='â• Ø¥Ø¶Ø§ÙØ© Shelf';addShelf.onclick=()=>{const id=prompt('Ø§Ø³Ù… Ø§Ù„Shelf Ù…Ø«Ù„Ø§Ù‹ SH4');if(!id)return;rk.shelves.push({id,boxes:[]});renderShelves();};const addBox=document.createElement('button');addBox.textContent='â• Ø¥Ø¶Ø§ÙØ© Box';addBox.onclick=()=>openModalForAdd();controls.appendChild(addShelf);controls.appendChild(addBox);app.appendChild(container);app.appendChild(controls);} 

// ---------- modal / form ----------
function openModalForAdd(){modal.classList.remove('hidden');const sStore=document.getElementById('modalStore'),sRack=document.getElementById('modalRack'),sShelf=document.getElementById('modalShelf');sStore.innerHTML='';sRack.innerHTML='';sShelf.innerHTML='';state.stores.forEach((st,i)=>{const o=document.createElement('option');o.value=i;o.textContent=st.name;sStore.appendChild(o);});sStore.value=state.storeIndex===null?0:state.storeIndex;populateRacks();sStore.onchange=populateRacks;document.getElementById('modalBoxId').value='';document.getElementById('modalBoxType').value='';}
function populateRacks(){const sStore=document.getElementById('modalStore'),sRack=document.getElementById('modalRack'),sShelf=document.getElementById('modalShelf');const st=state.stores[+sStore.value];sRack.innerHTML='';sShelf.innerHTML='';st.racks.forEach((r,ri)=>{const o=document.createElement('option');o.value=ri;o.textContent=r.id;sRack.appendChild(o);});sRack.onchange=()=>{const r=st.racks[+sRack.value];sShelf.innerHTML='';r.shelves.forEach((sh,si)=>{const o=document.createElement('option');o.value=si;o.textContent=sh.id;sShelf.appendChild(o);});};if(sRack.options.length>0)sRack.onchange();}

document.getElementById('modalCancel').onclick=()=>{modal.classList.add('hidden');};

// Ø­ÙØ¸ Ø¹Ø¨Ø± API
document.getElementById('modalSave').onclick=async ()=>{
  const si=+document.getElementById('modalStore').value,ri=+document.getElementById('modalRack').value,shi=+document.getElementById('modalShelf').value,boxId=document.getElementById('modalBoxId').value.trim(),boxType=document.getElementById('modalBoxType').value.trim();
  if(!boxId){alert('Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨ÙˆÙƒØ³');return;}
  const stName = state.stores[si].name;
  const rkId = state.stores[si].racks[ri].id;
  const shId = state.stores[si].racks[ri].shelves[shi].id;
  // Ù†Ø±Ø³Ù„ Ù„Ù„Ù€ API
  try{
    await apiAdd({store:stName, rack:rkId, shelf:shId, box:boxId, type:boxType});
    modal.classList.add('hidden');
    await load();
  }catch(err){
    alert('Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ÙØ¸ ÙØ´Ù„Øª. Ø§ÙØªØ­ console ÙˆØ§Ø¨Ø¹Ø« Ù„ÙŠ Ø§Ù„Ø®Ø·Ø£');
    console.error(err);
  }
};

// ---------- edit / delete ----------
window.deleteBox = async function(shIndex,boxId,_id){
  if(!confirm('Ø§Ù…Ø³Ø­ Box '+boxId+' ØŸ'))return;
  if(_id){
    await apiDelete(_id);
    await load();
  } else {
    alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ù„Ù„Ø­Ø°Ù Ø¹Ø¨Ø± Ø§Ù„Ø³ÙŠØ±ÙØ±. Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
    await load();
  }
}

window.editBox = async function(shIndex,boxId,_id){
  const newVal = prompt('Ø¹Ø¯Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨ÙˆÙƒØ³ Ø£Ùˆ Ù†ÙˆØ¹Ù‡', boxId);
  if(!newVal) return;
  if(_id){
    await apiUpdate(_id, {box: newVal});
    await load();
  } else {
    alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ø¨Ø± Ø§Ù„Ø³ÙŠØ±ÙØ±.');
    await load();
  }
}

// ---------- search & actions ----------
searchBtn.onclick=()=>{const q=(searchInput.value||'').trim();if(!q)return alert('Ø§ÙƒØªØ¨ Ø§Ù„Ù„ÙŠ Ù‡ØªØ¨Ø­Ø« Ø¹Ù†Ù‡');performSearch(q);} 
function performSearch(q){const results=[];state.stores.forEach(st=>{st.racks.forEach(rk=>{rk.shelves.forEach(sh=>{(sh.boxes||[]).forEach(box=>{const b = typeof box==='object'?box.boxId:String(box); if(String(b).includes(q)||(sh.note||'').includes(q))results.push({store:st.name,rack:rk.id,shelf:sh.id,box:b});});});});});if(results.length===0){alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬');return;}clearMain();const out=document.createElement('div');out.innerHTML=<h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« (${results.length})</h3>;results.forEach(r=>{const c=document.createElement('div');c.className='card';c.innerHTML=<strong>${r.box}</strong> â€” ${r.store} â€º ${r.rack} â€º ${r.shelf} <div><a target='_blank' href='https://chart.googleapis.com/chart?chs=150x150&cht=qr&chl=${encodeURIComponent(r.store+'|'+r.rack+'|'+r.shelf+'|'+r.box)}'>QR</a></div>;out.appendChild(c);});app.appendChild(out);}

backBtn.onclick=()=>{if(state.view==='racks')renderStores();else if(state.view==='shelves')renderRacks();}
addBtn.onclick=()=>openModalForAdd();

// start
init();
</script></body>
</html>
